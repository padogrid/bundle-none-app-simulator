#!/usr/bin/env bash
SCRIPT_DIR="$(cd -P -- "$(dirname -- "$0")" && pwd -P)"
. $SCRIPT_DIR/.addonenv.sh

EXECUTABLE="`basename $0`"

if [ "$HELP" == "true" ]; then
   echo "Usage:"
   echo "   ./$EXECUTABLE [-clean] [-?]"
   echo ""
   echo "   Builds the MQTT simulator environment."
   echo ""
   echo "Default: ./$EXECUTABLE"
   echo ""
   exit
fi

#if [ ! -d $APP_DIR/lib ]; then
#   mkdir -p $APP_DIR/lib
#fi

PADOGRID_COMMON_JAR_FILE_PATH=`ls $PADOGRID_HOME/lib/padogrid-common-*.jar`
PADOGRID_COMMON_JAR_FILE_NAME="`basename $PADOGRID_COMMON_JAR_FILE_PATH`"
PADOGRID_COMMON_NAME=${PADOGRID_COMMON_JAR_FILE_NAME%.jar}
ADDON_VERSION=${PADOGRID_COMMON_NAME#padogrid-common-}

PADOGRID_COMMON_JAR_FILE_PATH="$PADOGRID_HOME/lib/padogrid-common-$ADDON_VERSION.jar"
PADOGRID_MQTT_JAR_FILE_PATH="$PADOGRID_HOME/mosquitto/lib/padogrid-mqtt-$ADDON_VERSION.jar"

pushd $APP_DIR > /dev/null
sed -i$__SED_BACKUP -e "s|<padogrid.version>.*$|<padogrid.version>$PADOGRID_VERSION</padogrid.version>|g" pom.xml
popd > /dev/null

# Install the required padogrid packages to the local repo
installMavenPadogridJar padogrid-common
installMavenPadogridJar padogrid-mqtt

# Build app
pushd $APP_DIR > /dev/null
if [ "$CLEAN" == "true" ]; then
   rm $APP_DIR/lib/*
   mvn clean
else
   #mvn package -Dmaven.plugin.validation=brief
   mvn package
   cp $APP_DIR/lib/* $PADOGRID_WORKSPACE/lib/
fi
popd > /dev/null
